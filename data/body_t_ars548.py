import numpy as np

def body_T_x36d():
    """
    对应 MATLAB 的 Body_T_X36d()
    返回: 车身坐标系下 x36d 的外参 (4x4)
    """
    # MATLAB: x36d_R_xt32
    x36d_R_xt32 = np.array([
        [-0.001402106, -0.999967799, 0.007901562],
        [0.999997759, -0.001414596, -0.001575345],
        [0.001586472, 0.007899336, 0.999967541]
    ])

    body_R_xt32 = np.array([
        [0, -1, 0],
        [1,  0, 0],
        [0,  0, 1]
    ])

    # 对应 MATLAB: body_R_x36d = body_R_xt32 * transpose(x36d_R_xt32)
    body_R_x36d = body_R_xt32 @ x36d_R_xt32.T

    body_p_x36d = np.array([-0.06, 0.0, -0.16])

    T = np.eye(4)
    T[:3, :3] = body_R_x36d
    T[:3, 3] = body_p_x36d
    return T


def body_T_ars548(date):
    """
    对应 MATLAB 的 Body_T_Ars548(date)
    返回: 车身坐标系下 ARS548 的外参 (4x4)
    """
    p_body_ars548 = np.array([0, 0, 0.07])
    R_body_ars548 = np.eye(3)

    T_body_x36d = body_T_x36d()
    R_body_x36d = T_body_x36d[:3, :3]

    # 不同日期对应不同外参
    if date < 20231104:
        return None
    elif date < 20231105.5:
        R_x36d_ars548 = np.array([
            [0.969444991668881, 0.0114058478618076, -0.245043495654703],
            [-0.0138540154094491, 0.999869833844876, -0.00826931823403215],
            [0.244917280699337, 0.0114114855112841, 0.969476819533747]
        ])
    elif date < 20231109:
        R_x36d_ars548 = np.array([
            [0.99933556159366, 0.0350592694139522, 0.00996408362298175],
            [-0.0350697556851544, 0.999384479850069, 0.000879585692152998],
            [-0.00992711289698246, -0.00122843923992157, 0.999949970431803]
        ])
    elif date < 20231201:
        R_x36d_ars548 = np.array([
            [0.998776199461003, 0.0482799447996405, 0.0107308117297966],
            [-0.0484342320906938, 0.998719432121254, 0.0146157813744353],
            [-0.0100114210790212, -0.0151176331991534, 0.999835600793668]
        ])
    elif date < 20231208:
        R_x36d_ars548 = np.array([
            [0.99888971377047, 0.0432636174020788, -0.0186440106424698],
            [-0.0432064520575256, 0.999060179650875, 0.00345831412160802],
            [0.0187761078008922, -0.00264893285107753, 0.999820204302054]
        ])
    elif date < 20231213:
        R_x36d_ars548 = np.array([
            [0.998861908053375, 0.0445688670331839, -0.0169854270287433],
            [-0.0445188967507348, 0.999003062288094, 0.00330898339477966],
            [0.0171159712569224, -0.0025490449952668, 0.999850261737998]
        ])
    elif date < 20240113:
        R_x36d_ars548 = np.array([
            [0.99912647794293, 0.039117559886893, -0.0147002578838332],
            [-0.0390210149947843, 0.999215265264576, 0.00679809171902766],
            [0.0149546468407877, -0.00621853445265288, 0.999868835581512]
        ])
    else:
        R_x36d_ars548 = np.array([
            [0.998536832685765, 0.0494527313667313, -0.0218774114156895],
            [-0.0494029253854064, 0.998774972684787, 0.00281156573196022],
            [0.0219896505939817, -0.0017266438170843, 0.999756707388295]
        ])

    R_body_ars548 = R_body_x36d @ R_x36d_ars548

    T = np.eye(4)
    T[:3, :3] = R_body_ars548
    T[:3, 3] = p_body_ars548

    return T
